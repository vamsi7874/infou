{"version":3,"file":"EditViewPage.mjs","sources":["../../../../admin/src/pages/EditView/EditViewPage.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport {\n  Page,\n  Form,\n  useRBAC,\n  useNotification,\n  useQueryParams,\n  tours,\n} from '@strapi/admin/strapi-admin';\nimport { Grid, Main, Tabs, Box } from '@strapi/design-system';\nimport { useIntl } from 'react-intl';\nimport { useLocation, useParams } from 'react-router-dom';\nimport { styled } from 'styled-components';\n\nimport { SINGLE_TYPES } from '../../constants/collections';\nimport { PERMISSIONS } from '../../constants/plugin';\nimport { DocumentRBAC, useDocumentRBAC } from '../../features/DocumentRBAC';\nimport { useDoc, type UseDocument } from '../../hooks/useDocument';\nimport { useDocumentLayout } from '../../hooks/useDocumentLayout';\nimport { useLazyComponents } from '../../hooks/useLazyComponents';\nimport { useOnce } from '../../hooks/useOnce';\nimport { getTranslation } from '../../utils/translations';\nimport { createYupSchema } from '../../utils/validation';\n\nimport { Blocker } from './components/Blocker';\nimport { FormLayout } from './components/FormLayout';\nimport { Header } from './components/Header';\nimport { Panels } from './components/Panels';\nimport { handleInvisibleAttributes } from './utils/data';\n\n/* -------------------------------------------------------------------------------------------------\n * EditViewPage\n * -----------------------------------------------------------------------------------------------*/\n\nconst EditViewPage = () => {\n  const location = useLocation();\n  const [\n    {\n      query: { status },\n    },\n    setQuery,\n  ] = useQueryParams<{ status: 'draft' | 'published' }>({\n    status: 'draft',\n  });\n  const { formatMessage } = useIntl();\n  const { toggleNotification } = useNotification();\n\n  const doc = useDoc();\n  const {\n    document,\n    meta,\n    isLoading: isLoadingDocument,\n    schema,\n    components,\n    collectionType,\n    id,\n    model,\n    hasError,\n    getTitle,\n    getInitialFormValues,\n  } = doc;\n\n  const hasDraftAndPublished = schema?.options?.draftAndPublish ?? false;\n\n  useOnce(() => {\n    /**\n     * We only ever want to fire the notification once otherwise\n     * whenever the app re-renders it'll pop up regardless of\n     * what we do because the state comes from react-router-dom\n     */\n    if (location?.state && 'error' in location.state) {\n      toggleNotification({\n        type: 'danger',\n        message: location.state.error,\n        timeout: 5000,\n      });\n    }\n  });\n\n  const isLoadingActionsRBAC = useDocumentRBAC('EditViewPage', (state) => state.isLoading);\n\n  const isSingleType = collectionType === SINGLE_TYPES;\n\n  /**\n   * single-types don't current have an id, but because they're a singleton\n   * we can simply use the update operation to continuously update the same\n   * document with varying params.\n   */\n  const isCreatingDocument = !id && !isSingleType;\n\n  const {\n    isLoading: isLoadingLayout,\n    edit: {\n      layout,\n      settings: { mainField },\n    },\n  } = useDocumentLayout(model);\n  const pageTitle = getTitle(mainField);\n\n  const { isLazyLoading } = useLazyComponents([]);\n\n  const isLoading = isLoadingActionsRBAC || isLoadingDocument || isLoadingLayout || isLazyLoading;\n\n  const initialValues = getInitialFormValues(isCreatingDocument);\n\n  if (isLoading && !document?.documentId) {\n    return <Page.Loading />;\n  }\n\n  if (!initialValues || hasError) {\n    return <Page.Error />;\n  }\n\n  const handleTabChange = (status: string) => {\n    if (status === 'published' || status === 'draft') {\n      setQuery({ status }, 'push', true);\n    }\n  };\n\n  const validateSync = (values: Record<string, unknown>, options: Record<string, string>) => {\n    const yupSchema = createYupSchema(schema?.attributes, components, {\n      status,\n      ...options,\n    });\n\n    return yupSchema.validateSync(values, { abortEarly: false });\n  };\n\n  return (\n    <Main paddingLeft={10} paddingRight={10}>\n      <Page.Title>{pageTitle}</Page.Title>\n      {isSingleType && (\n        <tours.contentManager.Introduction>\n          {/* Invisible Anchor */}\n          <Box />\n        </tours.contentManager.Introduction>\n      )}\n      <Form\n        disabled={hasDraftAndPublished && status === 'published'}\n        initialValues={initialValues}\n        method={isCreatingDocument ? 'POST' : 'PUT'}\n        validate={(values: Record<string, unknown>, options: Record<string, string>) => {\n          // removes hidden fields from the validation\n          // this is necessary because the yup schema doesn't know about the visibility conditions\n          // and we don't want to validate fields that are not visible\n          const { data: cleanedValues, removedAttributes } = handleInvisibleAttributes(values, {\n            schema,\n            initialValues,\n            components,\n          });\n\n          const yupSchema = createYupSchema(schema?.attributes, components, {\n            status,\n            removedAttributes,\n            ...options,\n          });\n\n          return yupSchema.validate(cleanedValues, { abortEarly: false });\n        }}\n        initialErrors={location?.state?.forceValidation ? validateSync(initialValues, {}) : {}}\n      >\n        <>\n          <Header\n            isCreating={isCreatingDocument}\n            status={hasDraftAndPublished ? getDocumentStatus(document, meta) : undefined}\n            title={pageTitle}\n          />\n          <Tabs.Root variant=\"simple\" value={status} onValueChange={handleTabChange}>\n            <Tabs.List\n              aria-label={formatMessage({\n                id: getTranslation('containers.edit.tabs.label'),\n                defaultMessage: 'Document status',\n              })}\n            >\n              {hasDraftAndPublished ? (\n                <>\n                  <StatusTab value=\"draft\">\n                    {formatMessage({\n                      id: getTranslation('containers.edit.tabs.draft'),\n                      defaultMessage: 'draft',\n                    })}\n                  </StatusTab>\n                  <StatusTab\n                    disabled={!meta || meta.availableStatus.length === 0}\n                    value=\"published\"\n                  >\n                    {formatMessage({\n                      id: getTranslation('containers.edit.tabs.published'),\n                      defaultMessage: 'published',\n                    })}\n                  </StatusTab>\n                </>\n              ) : null}\n            </Tabs.List>\n            <Grid.Root paddingTop={8} gap={4}>\n              <Grid.Item col={9} s={12} direction=\"column\" alignItems=\"stretch\">\n                <Tabs.Content value=\"draft\">\n                  <tours.contentManager.Fields>\n                    <Box />\n                  </tours.contentManager.Fields>\n                  <FormLayout layout={layout} document={doc} />\n                </Tabs.Content>\n                <Tabs.Content value=\"published\">\n                  <FormLayout layout={layout} document={doc} />\n                </Tabs.Content>\n              </Grid.Item>\n              <Grid.Item col={3} s={12} direction=\"column\" alignItems=\"stretch\">\n                <Panels />\n              </Grid.Item>\n            </Grid.Root>\n          </Tabs.Root>\n          <Blocker />\n        </>\n      </Form>\n    </Main>\n  );\n};\n\nconst StatusTab = styled(Tabs.Trigger)`\n  text-transform: uppercase;\n`;\n\n/**\n * @internal\n * @description Returns the status of the document where its latest state takes priority,\n * this typically will be \"published\" unless a user has edited their draft in which we should\n * display \"modified\".\n */\nconst getDocumentStatus = (\n  document: ReturnType<UseDocument>['document'],\n  meta: ReturnType<UseDocument>['meta']\n): 'draft' | 'published' | 'modified' => {\n  const docStatus = document?.status;\n  const statuses = meta?.availableStatus ?? [];\n\n  /**\n   * Creating an entry\n   */\n  if (!docStatus) {\n    return 'draft';\n  }\n\n  /**\n   * We're viewing a draft, but the document could have a published version\n   */\n  if (docStatus === 'draft' && statuses.find((doc) => doc.publishedAt !== null)) {\n    return 'published';\n  }\n\n  return docStatus;\n};\n\n/* -------------------------------------------------------------------------------------------------\n * ProtectedEditViewPage\n * -----------------------------------------------------------------------------------------------*/\n\nconst ProtectedEditViewPage = () => {\n  const { slug = '' } = useParams<{\n    slug: string;\n  }>();\n  const {\n    permissions = [],\n    isLoading,\n    error,\n  } = useRBAC(\n    PERMISSIONS.map((action) => ({\n      action,\n      subject: slug,\n    }))\n  );\n\n  if (isLoading) {\n    return <Page.Loading />;\n  }\n\n  if (error || !slug) {\n    return <Page.Error />;\n  }\n\n  return (\n    <Page.Protect permissions={permissions}>\n      {({ permissions }) => (\n        <DocumentRBAC permissions={permissions}>\n          <EditViewPage />\n        </DocumentRBAC>\n      )}\n    </Page.Protect>\n  );\n};\n\nexport { EditViewPage, ProtectedEditViewPage, getDocumentStatus };\n"],"names":["EditViewPage","location","useLocation","query","status","setQuery","useQueryParams","formatMessage","useIntl","toggleNotification","useNotification","doc","useDoc","document","meta","isLoading","isLoadingDocument","schema","components","collectionType","id","model","hasError","getTitle","getInitialFormValues","hasDraftAndPublished","options","draftAndPublish","useOnce","state","type","message","error","timeout","isLoadingActionsRBAC","useDocumentRBAC","isSingleType","SINGLE_TYPES","isCreatingDocument","isLoadingLayout","edit","layout","settings","mainField","useDocumentLayout","pageTitle","isLazyLoading","useLazyComponents","initialValues","documentId","_jsx","Page","Loading","Error","handleTabChange","validateSync","values","yupSchema","createYupSchema","attributes","abortEarly","_jsxs","Main","paddingLeft","paddingRight","Title","tours","contentManager","Introduction","Box","Form","disabled","method","validate","data","cleanedValues","removedAttributes","handleInvisibleAttributes","initialErrors","forceValidation","_Fragment","Header","isCreating","getDocumentStatus","undefined","title","Tabs","Root","variant","value","onValueChange","List","aria-label","getTranslation","defaultMessage","StatusTab","availableStatus","length","Grid","paddingTop","gap","Item","col","s","direction","alignItems","Content","Fields","FormLayout","Panels","Blocker","styled","Trigger","docStatus","statuses","find","publishedAt","ProtectedEditViewPage","slug","useParams","permissions","useRBAC","PERMISSIONS","map","action","subject","Protect","DocumentRBAC"],"mappings":"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"}