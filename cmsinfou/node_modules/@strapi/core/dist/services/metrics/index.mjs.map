{"version":3,"file":"index.mjs","sources":["../../../src/services/metrics/index.ts"],"sourcesContent":["/**\n * Strapi telemetry package.\n * You can learn more at https://docs.strapi.io/developer-docs/latest/getting-started/usage-information.html\n */\n\nimport type { Core } from '@strapi/types';\n\nimport wrapWithRateLimit from './rate-limiter';\nimport createSender from './sender';\nimport createMiddleware from './middleware';\nimport isTruthy from './is-truthy';\n\nconst LIMITED_EVENTS = [\n  'didSaveMediaWithAlternativeText',\n  'didSaveMediaWithCaption',\n  'didDisableResponsiveDimensions',\n  'didEnableResponsiveDimensions',\n  'didInitializePluginUpload',\n];\n\nconst createTelemetryInstance = (strapi: Core.Strapi) => {\n  const uuid = strapi.config.get('uuid');\n  const telemetryDisabled = strapi.config.get('packageJsonStrapi.telemetryDisabled');\n  const isDisabled =\n    !uuid || isTruthy(process.env.STRAPI_TELEMETRY_DISABLED) || isTruthy(telemetryDisabled);\n\n  const sender = createSender(strapi);\n  const sendEvent = wrapWithRateLimit(sender, { limitedEvents: LIMITED_EVENTS });\n\n  return {\n    get isDisabled() {\n      return isDisabled;\n    },\n\n    register() {\n      if (!isDisabled) {\n        strapi.cron.add({\n          sendPingEvent: {\n            task: () => sendEvent('ping'),\n            options: '0 0 12 * * *',\n          },\n        });\n\n        strapi.server.use(createMiddleware({ sendEvent, strapi }));\n      }\n    },\n\n    bootstrap() {},\n\n    async send(event: string, payload: Record<string, unknown> = {}) {\n      if (isDisabled) return true;\n      return sendEvent(event, payload);\n    },\n\n    destroy() {\n      // Clean up resources if needed\n    },\n  };\n};\n\nexport default createTelemetryInstance;\n"],"names":["LIMITED_EVENTS","createTelemetryInstance","strapi","uuid","config","get","telemetryDisabled","isDisabled","isTruthy","process","env","STRAPI_TELEMETRY_DISABLED","sender","createSender","sendEvent","wrapWithRateLimit","limitedEvents","register","cron","add","sendPingEvent","task","options","server","use","createMiddleware","bootstrap","send","event","payload","destroy"],"mappings":";;;;;AAYA,MAAMA,cAAiB,GAAA;AACrB,IAAA,iCAAA;AACA,IAAA,yBAAA;AACA,IAAA,gCAAA;AACA,IAAA,+BAAA;AACA,IAAA;AACD,CAAA;AAED,MAAMC,0BAA0B,CAACC,MAAAA,GAAAA;AAC/B,IAAA,MAAMC,IAAOD,GAAAA,MAAAA,CAAOE,MAAM,CAACC,GAAG,CAAC,MAAA,CAAA;AAC/B,IAAA,MAAMC,iBAAoBJ,GAAAA,MAAAA,CAAOE,MAAM,CAACC,GAAG,CAAC,qCAAA,CAAA;IAC5C,MAAME,UAAAA,GACJ,CAACJ,IAAQK,IAAAA,QAAAA,CAASC,QAAQC,GAAG,CAACC,yBAAyB,CAAA,IAAKH,QAASF,CAAAA,iBAAAA,CAAAA;AAEvE,IAAA,MAAMM,SAASC,YAAaX,CAAAA,MAAAA,CAAAA;IAC5B,MAAMY,SAAAA,GAAYC,kBAAkBH,MAAQ,EAAA;QAAEI,aAAehB,EAAAA;AAAe,KAAA,CAAA;IAE5E,OAAO;AACL,QAAA,IAAIO,UAAa,CAAA,GAAA;YACf,OAAOA,UAAAA;AACT,SAAA;AAEAU,QAAAA,QAAAA,CAAAA,GAAAA;AACE,YAAA,IAAI,CAACV,UAAY,EAAA;gBACfL,MAAOgB,CAAAA,IAAI,CAACC,GAAG,CAAC;oBACdC,aAAe,EAAA;AACbC,wBAAAA,IAAAA,EAAM,IAAMP,SAAU,CAAA,MAAA,CAAA;wBACtBQ,OAAS,EAAA;AACX;AACF,iBAAA,CAAA;AAEApB,gBAAAA,MAAAA,CAAOqB,MAAM,CAACC,GAAG,CAACC,gBAAiB,CAAA;AAAEX,oBAAAA,SAAAA;AAAWZ,oBAAAA;AAAO,iBAAA,CAAA,CAAA;AACzD;AACF,SAAA;QAEAwB,SAAa,CAAA,GAAA,EAAA;AAEb,QAAA,MAAMC,IAAKC,CAAAA,CAAAA,KAAa,EAAEC,OAAAA,GAAmC,EAAE,EAAA;AAC7D,YAAA,IAAItB,YAAY,OAAO,IAAA;AACvB,YAAA,OAAOO,UAAUc,KAAOC,EAAAA,OAAAA,CAAAA;AAC1B,SAAA;AAEAC,QAAAA,OAAAA,CAAAA,GAAAA;;AAEA;AACF,KAAA;AACF;;;;"}