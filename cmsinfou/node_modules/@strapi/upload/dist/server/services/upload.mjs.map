{"version":3,"file":"upload.mjs","sources":["../../../server/src/services/upload.ts"],"sourcesContent":["import os from 'os';\nimport path from 'path';\nimport fs from 'fs';\nimport fse from 'fs-extra';\nimport _ from 'lodash';\nimport { extension } from 'mime-types';\nimport {\n  async,\n  sanitize,\n  contentTypes as contentTypesUtils,\n  errors,\n  file as fileUtils,\n} from '@strapi/utils';\n\nimport type { Core, UID } from '@strapi/types';\n\nimport { FILE_MODEL_UID, ALLOWED_WEBHOOK_EVENTS } from '../constants';\nimport { getService } from '../utils';\n\nimport type { Config, File, InputFile, UploadableFile, FileInfo } from '../types';\nimport type { ViewConfiguration } from '../controllers/validation/admin/configureView';\nimport type { Settings } from '../controllers/validation/admin/settings';\n\ntype User = {\n  id: string | number;\n};\n\ntype ID = string | number;\n\ntype CommonOptions = {\n  user?: User;\n};\n\ntype Metas = {\n  refId?: ID;\n  ref?: string;\n  field?: string;\n  path?: string;\n  tmpWorkingDirectory?: string;\n};\n\nconst { UPDATED_BY_ATTRIBUTE, CREATED_BY_ATTRIBUTE } = contentTypesUtils.constants;\nconst { MEDIA_CREATE, MEDIA_UPDATE, MEDIA_DELETE } = ALLOWED_WEBHOOK_EVENTS;\n\nconst { ApplicationError, NotFoundError } = errors;\nconst { bytesToKbytes } = fileUtils;\n\nexport default ({ strapi }: { strapi: Core.Strapi }) => {\n  const fileService = getService('file');\n\n  const sendMediaMetrics = (data: Pick<File, 'caption' | 'alternativeText'>) => {\n    if (_.has(data, 'caption') && !_.isEmpty(data.caption)) {\n      strapi.telemetry.send('didSaveMediaWithCaption');\n    }\n\n    if (_.has(data, 'alternativeText') && !_.isEmpty(data.alternativeText)) {\n      strapi.telemetry.send('didSaveMediaWithAlternativeText');\n    }\n  };\n\n  const createAndAssignTmpWorkingDirectoryToFiles = async (\n    files: InputFile | InputFile[]\n  ): Promise<string> => {\n    const tmpWorkingDirectory = await fse.mkdtemp(path.join(os.tmpdir(), 'strapi-upload-'));\n\n    if (Array.isArray(files)) {\n      files.forEach((file) => {\n        file.tmpWorkingDirectory = tmpWorkingDirectory;\n      });\n    } else {\n      files.tmpWorkingDirectory = tmpWorkingDirectory;\n    }\n\n    return tmpWorkingDirectory;\n  };\n\n  function filenameReservedRegex() {\n    // eslint-disable-next-line no-control-regex\n    return /[<>:\"/\\\\|?*\\u0000-\\u001F]/g;\n  }\n\n  function windowsReservedNameRegex() {\n    return /^(con|prn|aux|nul|com\\d|lpt\\d)$/i;\n  }\n\n  /**\n   * Copied from https://github.com/sindresorhus/valid-filename package\n   */\n  function isValidFilename(string: string) {\n    if (!string || string.length > 255) {\n      return false;\n    }\n    if (filenameReservedRegex().test(string) || windowsReservedNameRegex().test(string)) {\n      return false;\n    }\n    if (string === '.' || string === '..') {\n      return false;\n    }\n    return true;\n  }\n\n  async function emitEvent(event: string, data: Record<string, any>) {\n    const modelDef = strapi.getModel(FILE_MODEL_UID);\n    const sanitizedData = await sanitize.sanitizers.defaultSanitizeOutput(\n      {\n        schema: modelDef,\n        getModel(uid: string) {\n          return strapi.getModel(uid as UID.Schema);\n        },\n      },\n      data\n    );\n\n    strapi.eventHub.emit(event, { media: sanitizedData });\n  }\n\n  async function formatFileInfo(\n    { filename, type, size }: { filename: string; type: string; size: number },\n    fileInfo: Partial<FileInfo> = {},\n    metas: {\n      refId?: ID;\n      ref?: string;\n      field?: string;\n      path?: string;\n      tmpWorkingDirectory?: string;\n    } = {}\n  ): Promise<Omit<UploadableFile, 'getStream'>> {\n    const fileService = getService('file');\n    const imageManipulationService = getService('image-manipulation');\n\n    if (!isValidFilename(filename)) {\n      throw new ApplicationError('File name contains invalid characters');\n    }\n\n    let ext = path.extname(filename);\n    if (!ext) {\n      ext = `.${extension(type)}`;\n    }\n    const usedName = (fileInfo.name || filename).normalize();\n    const basename = path.basename(usedName, ext);\n\n    // Prevent null characters in file name\n    if (!isValidFilename(filename)) {\n      throw new ApplicationError('File name contains invalid characters');\n    }\n\n    const entity: Omit<UploadableFile, 'getStream'> = {\n      name: usedName,\n      alternativeText: fileInfo.alternativeText,\n      caption: fileInfo.caption,\n      folder: fileInfo.folder,\n      folderPath: await fileService.getFolderPath(fileInfo.folder),\n      hash: imageManipulationService.generateFileName(basename),\n      ext,\n      mime: type,\n      size: bytesToKbytes(size),\n      sizeInBytes: size,\n    };\n\n    const { refId, ref, field } = metas;\n\n    if (refId && ref && field) {\n      entity.related = [\n        {\n          id: refId,\n          __type: ref,\n          __pivot: { field },\n        },\n      ];\n    }\n\n    if (metas.path) {\n      entity.path = metas.path;\n    }\n\n    if (metas.tmpWorkingDirectory) {\n      entity.tmpWorkingDirectory = metas.tmpWorkingDirectory;\n    }\n\n    return entity;\n  }\n\n  async function enhanceAndValidateFile(\n    file: InputFile,\n    fileInfo: FileInfo,\n    metas?: Metas\n  ): Promise<UploadableFile> {\n    const currentFile = (await formatFileInfo(\n      {\n        filename: file.originalFilename ?? 'unamed',\n        type: file.mimetype ?? 'application/octet-stream',\n        size: file.size,\n      },\n      fileInfo,\n      {\n        ...metas,\n        tmpWorkingDirectory: file.tmpWorkingDirectory,\n      }\n    )) as UploadableFile;\n\n    currentFile.filepath = file.filepath;\n    currentFile.getStream = () => fs.createReadStream(file.filepath);\n\n    const { optimize, isImage, isFaultyImage, isOptimizableImage } = strapi\n      .plugin('upload')\n      .service('image-manipulation');\n\n    if (await isImage(currentFile)) {\n      if (await isFaultyImage(currentFile)) {\n        throw new ApplicationError('File is not a valid image');\n      }\n      if (await isOptimizableImage(currentFile)) {\n        return optimize(currentFile);\n      }\n    }\n\n    return currentFile;\n  }\n\n  async function upload(\n    {\n      data,\n      files,\n    }: {\n      data: Record<string, unknown>;\n      files: InputFile | InputFile[];\n    },\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n    // create temporary folder to store files for stream manipulation\n    const tmpWorkingDirectory = await createAndAssignTmpWorkingDirectoryToFiles(files);\n\n    let uploadedFiles: any[] = [];\n\n    try {\n      const { fileInfo, ...metas } = data;\n\n      const fileArray = Array.isArray(files) ? files : [files];\n      const fileInfoArray = Array.isArray(fileInfo) ? fileInfo : [fileInfo];\n\n      const doUpload = async (file: InputFile, fileInfo: FileInfo) => {\n        const fileData = await enhanceAndValidateFile(file, fileInfo, metas);\n        return uploadFileAndPersist(fileData, { user });\n      };\n\n      uploadedFiles = await Promise.all(\n        fileArray.map((file, idx) => doUpload(file, fileInfoArray[idx] || {}))\n      );\n    } finally {\n      // delete temporary folder\n      await fse.remove(tmpWorkingDirectory);\n    }\n\n    return uploadedFiles;\n  }\n\n  /**\n   * When uploading an image, an additional thumbnail is generated.\n   * Also, if there are responsive formats defined, another set of images will be generated too.\n   *\n   * @param {*} fileData\n   */\n  async function uploadImage(fileData: UploadableFile) {\n    const { getDimensions, generateThumbnail, generateResponsiveFormats, isResizableImage } =\n      getService('image-manipulation');\n\n    // Store width and height of the original image\n    const { width, height } = await getDimensions(fileData);\n\n    // Make sure this is assigned before calling any upload\n    // That way it can mutate the width and height\n    _.assign(fileData, {\n      width,\n      height,\n    });\n\n    // For performance reasons, all uploads are wrapped in a single Promise.all\n    const uploadThumbnail = async (thumbnailFile: UploadableFile) => {\n      await getService('provider').upload(thumbnailFile);\n      _.set(fileData, 'formats.thumbnail', thumbnailFile);\n    };\n\n    // Generate thumbnail and responsive formats\n    const uploadResponsiveFormat = async (format: { key: string; file: UploadableFile }) => {\n      const { key, file } = format;\n      await getService('provider').upload(file);\n      _.set(fileData, ['formats', key], file);\n    };\n\n    const uploadPromises: Promise<void>[] = [];\n\n    // Upload image\n    uploadPromises.push(getService('provider').upload(fileData));\n\n    // Generate & Upload thumbnail and responsive formats\n    if (await isResizableImage(fileData)) {\n      const thumbnailFile = await generateThumbnail(fileData);\n      if (thumbnailFile) {\n        uploadPromises.push(uploadThumbnail(thumbnailFile));\n      }\n\n      const formats = await generateResponsiveFormats(fileData);\n      if (Array.isArray(formats) && formats.length > 0) {\n        for (const format of formats) {\n          // eslint-disable-next-line no-continue\n          if (!format) continue;\n          uploadPromises.push(uploadResponsiveFormat(format));\n        }\n      }\n    }\n    // Wait for all uploads to finish\n    await Promise.all(uploadPromises);\n  }\n\n  /**\n   * Upload a file. If it is an image it will generate a thumbnail\n   * and responsive formats (if enabled).\n   */\n  async function uploadFileAndPersist(fileData: UploadableFile, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const config = strapi.config.get<Config>('plugin::upload');\n    const { isImage } = getService('image-manipulation');\n\n    await getService('provider').checkFileSize(fileData);\n\n    if (await isImage(fileData)) {\n      await uploadImage(fileData);\n    } else {\n      await getService('provider').upload(fileData);\n    }\n\n    _.set(fileData, 'provider', config.provider);\n\n    // Persist file(s)\n    return add(fileData, { user });\n  }\n\n  async function updateFileInfo(\n    id: ID,\n    { name, alternativeText, caption, folder }: FileInfo,\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n\n    const dbFile = await findOne(id);\n\n    if (!dbFile) {\n      throw new NotFoundError();\n    }\n\n    const fileService = getService('file');\n\n    const newName = _.isNil(name) ? dbFile.name : name;\n    const newInfos = {\n      name: newName,\n      alternativeText: _.isNil(alternativeText) ? dbFile.alternativeText : alternativeText,\n      caption: _.isNil(caption) ? dbFile.caption : caption,\n      folder: _.isUndefined(folder) ? dbFile.folder : folder,\n      folderPath: _.isUndefined(folder) ? dbFile.path : await fileService.getFolderPath(folder),\n    };\n\n    return update(id, newInfos, { user });\n  }\n\n  async function replace(\n    id: ID,\n    { data, file }: { data: { fileInfo: FileInfo }; file: InputFile },\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n\n    const config = strapi.config.get<Config>('plugin::upload');\n\n    const { isImage } = getService('image-manipulation');\n\n    const dbFile = await findOne(id);\n    if (!dbFile) {\n      throw new NotFoundError();\n    }\n\n    // create temporary folder to store files for stream manipulation\n    const tmpWorkingDirectory = await createAndAssignTmpWorkingDirectoryToFiles(file);\n\n    let fileData: UploadableFile;\n\n    try {\n      const { fileInfo } = data;\n      fileData = await enhanceAndValidateFile(file, fileInfo);\n\n      // keep a constant hash and extension so the file url doesn't change when the file is replaced\n      _.assign(fileData, {\n        hash: dbFile.hash,\n        ext: dbFile.ext,\n      });\n\n      // execute delete function of the provider\n      if (dbFile.provider === config.provider) {\n        await strapi.plugin('upload').provider.delete(dbFile);\n\n        if (dbFile.formats) {\n          await Promise.all(\n            Object.keys(dbFile.formats).map((key) => {\n              return strapi.plugin('upload').provider.delete(dbFile.formats[key]);\n            })\n          );\n        }\n      }\n\n      // clear old formats\n      _.set(fileData, 'formats', {});\n\n      if (await isImage(fileData)) {\n        await uploadImage(fileData);\n      } else {\n        await getService('provider').upload(fileData);\n      }\n\n      _.set(fileData, 'provider', config.provider);\n    } finally {\n      // delete temporary folder\n      await fse.remove(tmpWorkingDirectory);\n    }\n\n    return update(id, fileData, { user });\n  }\n\n  async function update(id: ID, values: Partial<File>, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const fileValues = { ...values };\n    if (user) {\n      Object.assign(fileValues, {\n        [UPDATED_BY_ATTRIBUTE]: user.id,\n      });\n    }\n\n    sendMediaMetrics(fileValues);\n\n    const res = await strapi.db.query(FILE_MODEL_UID).update({ where: { id }, data: fileValues });\n\n    await emitEvent(MEDIA_UPDATE, res);\n\n    return res;\n  }\n\n  async function add(values: any, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const fileValues = { ...values };\n    if (user) {\n      Object.assign(fileValues, {\n        [UPDATED_BY_ATTRIBUTE]: user.id,\n        [CREATED_BY_ATTRIBUTE]: user.id,\n      });\n    }\n\n    sendMediaMetrics(fileValues);\n\n    const res = await strapi.db.query(FILE_MODEL_UID).create({ data: fileValues });\n\n    await emitEvent(MEDIA_CREATE, res);\n\n    return res;\n  }\n\n  async function findOne(id: ID, populate = {}) {\n    const query = strapi.get('query-params').transform(FILE_MODEL_UID, {\n      populate,\n    });\n\n    const file = await strapi.db.query(FILE_MODEL_UID).findOne({\n      where: { id },\n      ...query,\n    });\n\n    if (!file) return file;\n\n    // Sign file URLs if using private provider\n    return fileService.signFileUrls(file);\n  }\n\n  async function findMany(query: any = {}): Promise<File[]> {\n    const files = await strapi.db\n      .query(FILE_MODEL_UID)\n      .findMany(strapi.get('query-params').transform(FILE_MODEL_UID, query));\n\n    // Sign file URLs if using private provider\n    return async.map(files, (file: File) => fileService.signFileUrls(file));\n  }\n\n  async function findPage(query: any = {}) {\n    const result = await strapi.db\n      .query(FILE_MODEL_UID)\n      .findPage(strapi.get('query-params').transform(FILE_MODEL_UID, query));\n\n    // Sign file URLs if using private provider\n    const signedResults = await async.map(result.results, (file: File) =>\n      fileService.signFileUrls(file)\n    );\n\n    return {\n      ...result,\n      results: signedResults,\n    };\n  }\n\n  async function remove(file: File) {\n    const config = strapi.config.get<Config>('plugin::upload');\n\n    // execute delete function of the provider\n    if (file.provider === config.provider) {\n      await strapi.plugin('upload').provider.delete(file);\n\n      if (file.formats) {\n        const keys = Object.keys(file.formats);\n\n        await Promise.all(\n          keys.map((key) => {\n            return strapi.plugin('upload').provider.delete(file.formats![key]);\n          })\n        );\n      }\n    }\n\n    const media = await strapi.db.query(FILE_MODEL_UID).findOne({\n      where: { id: file.id },\n    });\n\n    await emitEvent(MEDIA_DELETE, media);\n\n    return strapi.db.query(FILE_MODEL_UID).delete({ where: { id: file.id } });\n  }\n\n  async function getSettings() {\n    const res = await strapi.store!({ type: 'plugin', name: 'upload', key: 'settings' }).get({});\n\n    return res as Settings | null;\n  }\n\n  function setSettings(value: Settings) {\n    if (value.responsiveDimensions === true) {\n      strapi.telemetry.send('didEnableResponsiveDimensions');\n    } else {\n      strapi.telemetry.send('didDisableResponsiveDimensions');\n    }\n\n    return strapi.store!({ type: 'plugin', name: 'upload', key: 'settings' }).set({ value });\n  }\n\n  async function getConfiguration() {\n    const res = await strapi.store!({\n      type: 'plugin',\n      name: 'upload',\n      key: 'view_configuration',\n    }).get({});\n\n    return res as ViewConfiguration | null;\n  }\n\n  function setConfiguration(value: ViewConfiguration) {\n    return strapi.store!({ type: 'plugin', name: 'upload', key: 'view_configuration' }).set({\n      value,\n    });\n  }\n\n  return {\n    formatFileInfo,\n    upload,\n    updateFileInfo,\n    replace,\n    findOne,\n    findMany,\n    findPage,\n    remove,\n    getSettings,\n    setSettings,\n    getConfiguration,\n    setConfiguration,\n\n    /**\n     * exposed for testing only\n     * @internal\n     */\n    _uploadImage: uploadImage,\n  };\n};\n"],"names":["UPDATED_BY_ATTRIBUTE","CREATED_BY_ATTRIBUTE","contentTypesUtils","constants","MEDIA_CREATE","MEDIA_UPDATE","MEDIA_DELETE","ALLOWED_WEBHOOK_EVENTS","ApplicationError","NotFoundError","errors","bytesToKbytes","fileUtils","strapi","fileService","getService","sendMediaMetrics","data","_","has","isEmpty","caption","telemetry","send","alternativeText","createAndAssignTmpWorkingDirectoryToFiles","files","tmpWorkingDirectory","fse","mkdtemp","path","join","os","tmpdir","Array","isArray","forEach","file","filenameReservedRegex","windowsReservedNameRegex","isValidFilename","string","length","test","emitEvent","event","modelDef","getModel","FILE_MODEL_UID","sanitizedData","sanitize","sanitizers","defaultSanitizeOutput","schema","uid","eventHub","emit","media","formatFileInfo","filename","type","size","fileInfo","metas","imageManipulationService","ext","extname","extension","usedName","name","normalize","basename","entity","folder","folderPath","getFolderPath","hash","generateFileName","mime","sizeInBytes","refId","ref","field","related","id","__type","__pivot","enhanceAndValidateFile","currentFile","originalFilename","mimetype","filepath","getStream","fs","createReadStream","optimize","isImage","isFaultyImage","isOptimizableImage","plugin","service","upload","opts","user","uploadedFiles","fileArray","fileInfoArray","doUpload","fileData","uploadFileAndPersist","Promise","all","map","idx","remove","uploadImage","getDimensions","generateThumbnail","generateResponsiveFormats","isResizableImage","width","height","assign","uploadThumbnail","thumbnailFile","set","uploadResponsiveFormat","format","key","uploadPromises","push","formats","config","get","checkFileSize","provider","add","updateFileInfo","dbFile","findOne","newName","isNil","newInfos","isUndefined","update","replace","delete","Object","keys","values","fileValues","res","db","query","where","create","populate","transform","signFileUrls","findMany","async","findPage","result","signedResults","results","getSettings","store","setSettings","value","responsiveDimensions","getConfiguration","setConfiguration","_uploadImage"],"mappings":"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"}