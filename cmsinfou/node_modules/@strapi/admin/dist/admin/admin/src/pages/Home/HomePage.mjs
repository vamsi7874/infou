import { jsx, jsxs } from 'react/jsx-runtime';
import * as React from 'react';
import { Main, Flex, Box, Grid, Typography } from '@strapi/design-system';
import { PuzzlePiece } from '@strapi/icons';
import { useIntl } from 'react-intl';
import { Link } from 'react-router-dom';
import { GuidedTourHomepageOverview } from '../../components/GuidedTour/Overview.mjs';
import { Layouts } from '../../components/Layouts/Layout.mjs';
import { Page } from '../../components/PageHelpers.mjs';
import { Widget } from '../../components/WidgetHelpers.mjs';
import '../../services/admin.mjs';
import { useEnterprise } from '../../hooks/useEnterprise.mjs';
import { useAuth } from '../../features/Auth.mjs';
import { useStrapiApp } from '../../features/StrapiApp.mjs';
import { useTracking } from '../../features/Tracking.mjs';
import { FreeTrialEndedModal } from './components/FreeTrialEndedModal.mjs';
import { FreeTrialWelcomeModal } from './components/FreeTrialWelcomeModal.mjs';

const WidgetRoot = ({ title, icon = PuzzlePiece, children, link, uid })=>{
    const { trackUsage } = useTracking();
    const { formatMessage } = useIntl();
    const id = React.useId();
    const Icon = icon;
    const handleClickOnLink = ()=>{
        trackUsage('didOpenHomeWidgetLink', {
            widgetUID: uid
        });
    };
    return /*#__PURE__*/ jsxs(Flex, {
        width: "100%",
        hasRadius: true,
        direction: "column",
        alignItems: "flex-start",
        background: "neutral0",
        borderColor: "neutral150",
        shadow: "tableShadow",
        tag: "section",
        gap: 4,
        padding: 6,
        "aria-labelledby": id,
        children: [
            /*#__PURE__*/ jsxs(Flex, {
                direction: "row",
                gap: 2,
                justifyContent: "space-between",
                width: "100%",
                tag: "header",
                children: [
                    /*#__PURE__*/ jsxs(Flex, {
                        gap: 2,
                        children: [
                            /*#__PURE__*/ jsx(Icon, {
                                fill: "neutral500",
                                "aria-hidden": true
                            }),
                            /*#__PURE__*/ jsx(Typography, {
                                textColor: "neutral500",
                                variant: "sigma",
                                tag: "h2",
                                id: id,
                                children: formatMessage(title)
                            })
                        ]
                    }),
                    link && /*#__PURE__*/ jsx(Typography, {
                        tag: Link,
                        variant: "omega",
                        textColor: "primary600",
                        style: {
                            textDecoration: 'none'
                        },
                        textAlign: "right",
                        to: link.href,
                        onClick: handleClickOnLink,
                        children: formatMessage(link.label)
                    })
                ]
            }),
            /*#__PURE__*/ jsx(Box, {
                width: "100%",
                height: "261px",
                overflow: "auto",
                tag: "main",
                children: children
            })
        ]
    });
};
/* -------------------------------------------------------------------------------------------------
 * UnstableHomePageCe
 * -----------------------------------------------------------------------------------------------*/ const WidgetComponent = ({ component })=>{
    const [loadedComponent, setLoadedComponent] = React.useState(null);
    React.useEffect(()=>{
        const loadComponent = async ()=>{
            const resolvedComponent = await component();
            setLoadedComponent(()=>resolvedComponent);
        };
        loadComponent();
    }, [
        component
    ]);
    const Component = loadedComponent;
    if (!Component) {
        return /*#__PURE__*/ jsx(Widget.Loading, {});
    }
    return /*#__PURE__*/ jsx(Component, {});
};
/* -------------------------------------------------------------------------------------------------
 * HomePageCE
 * -----------------------------------------------------------------------------------------------*/ const HomePageCE = ()=>{
    const { formatMessage } = useIntl();
    const user = useAuth('HomePageCE', (state)=>state.user);
    const displayName = user?.firstname ?? user?.username ?? user?.email;
    const getAllWidgets = useStrapiApp('UnstableHomepageCe', (state)=>state.widgets.getAll);
    const checkUserHasPermissions = useAuth('WidgetRoot', (state)=>state.checkUserHasPermissions);
    const [filteredWidgets, setFilteredWidgets] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    React.useEffect(()=>{
        const checkWidgetsPermissions = async ()=>{
            const allWidgets = getAllWidgets();
            const authorizedWidgets = await Promise.all(allWidgets.map(async (widget)=>{
                if (!widget.permissions || widget.permissions.length === 0) return true;
                const matchingPermissions = await checkUserHasPermissions(widget.permissions);
                return matchingPermissions.length >= widget.permissions.length;
            }));
            setFilteredWidgets(allWidgets.filter((_, i)=>authorizedWidgets[i]));
            setLoading(false);
        };
        checkWidgetsPermissions();
    }, [
        checkUserHasPermissions,
        getAllWidgets
    ]);
    return /*#__PURE__*/ jsxs(Main, {
        children: [
            /*#__PURE__*/ jsx(Page.Title, {
                children: formatMessage({
                    id: 'HomePage.head.title',
                    defaultMessage: 'Homepage'
                })
            }),
            /*#__PURE__*/ jsx(Layouts.Header, {
                title: formatMessage({
                    id: 'HomePage.header.title',
                    defaultMessage: 'Hello {name}'
                }, {
                    name: displayName
                }),
                subtitle: formatMessage({
                    id: 'HomePage.header.subtitle',
                    defaultMessage: 'Welcome to your administration panel'
                })
            }),
            /*#__PURE__*/ jsx(FreeTrialWelcomeModal, {}),
            /*#__PURE__*/ jsx(FreeTrialEndedModal, {}),
            /*#__PURE__*/ jsx(Layouts.Content, {
                children: /*#__PURE__*/ jsxs(Flex, {
                    direction: "column",
                    alignItems: "stretch",
                    gap: 8,
                    paddingBottom: 10,
                    children: [
                        /*#__PURE__*/ jsx(GuidedTourHomepageOverview, {}),
                        loading ? /*#__PURE__*/ jsx(Box, {
                            position: "absolute",
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            children: /*#__PURE__*/ jsx(Page.Loading, {})
                        }) : /*#__PURE__*/ jsx(Grid.Root, {
                            gap: 5,
                            children: filteredWidgets.map((widget)=>/*#__PURE__*/ jsx(Grid.Item, {
                                    col: 6,
                                    s: 12,
                                    children: /*#__PURE__*/ jsx(WidgetRoot, {
                                        title: widget.title,
                                        icon: widget.icon,
                                        link: widget.link,
                                        uid: widget.uid,
                                        children: /*#__PURE__*/ jsx(WidgetComponent, {
                                            component: widget.component
                                        })
                                    })
                                }, widget.uid))
                        })
                    ]
                })
            })
        ]
    });
};
/* -------------------------------------------------------------------------------------------------
 * HomePage
 * -----------------------------------------------------------------------------------------------*/ const HomePage = ()=>{
    const Page = useEnterprise(HomePageCE, // eslint-disable-next-line import/no-cycle
    async ()=>(await import('../../../../ee/admin/src/pages/HomePage.mjs')).HomePageEE);
    // block rendering until the EE component is fully loaded
    if (!Page) {
        return null;
    }
    return /*#__PURE__*/ jsx(Page, {});
};

export { HomePage, HomePageCE, WidgetRoot };
//# sourceMappingURL=HomePage.mjs.map
