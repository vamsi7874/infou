{"version":3,"file":"Context.js","sources":["../../../../../../admin/src/components/GuidedTour/Context.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport { produce } from 'immer';\n\nimport { useTracking } from '../../features/Tracking';\nimport { usePersistentState } from '../../hooks/usePersistentState';\nimport { createContext } from '../Context';\n\nimport { type Tours, tours as guidedTours } from './Tours';\nimport { GUIDED_TOUR_REQUIRED_ACTIONS } from './utils/constants';\nimport { migrateTours } from './utils/migrations';\n\n/* -------------------------------------------------------------------------------------------------\n * GuidedTourProvider\n * -----------------------------------------------------------------------------------------------*/\n\ntype ValidTourName = keyof Tours;\n\n/**\n * Derive the union of all string literal values from GUIDED_TOUR_REQUIRED_ACTIONS\n * (ie didCreateContentTypeSchema | didCreateContent etc...)\n */\ntype ValueOf<T> = T[keyof T];\ntype NonEmptyValueOf<T> = T extends Record<string, never> ? never : ValueOf<T>;\nexport type CompletedActions = NonEmptyValueOf<ValueOf<typeof GUIDED_TOUR_REQUIRED_ACTIONS>>[];\n\ntype Action =\n  | {\n      type: 'next_step';\n      payload: ValidTourName;\n    }\n  | {\n      type: 'previous_step';\n      payload: ValidTourName;\n    }\n  | {\n      type: 'go_to_step';\n      payload: {\n        tourName: ValidTourName;\n        step: number;\n      };\n    }\n  | {\n      type: 'skip_tour';\n      payload: ValidTourName;\n    }\n  | {\n      type: 'skip_all_tours';\n    }\n  | {\n      type: 'reset_all_tours';\n    }\n  | {\n      type: 'set_completed_actions';\n      payload: CompletedActions;\n    }\n  | {\n      type: 'remove_completed_action';\n      payload: ValueOf<CompletedActions>;\n    };\n\ntype TourState = Record<ValidTourName, { currentStep: number; isCompleted: boolean }>;\ntype State = {\n  tours: TourState;\n  enabled: boolean;\n  completedActions: CompletedActions;\n};\n\nconst [GuidedTourProviderImpl, useGuidedTour] = createContext<{\n  state: State;\n  dispatch: React.Dispatch<Action>;\n}>('GuidedTour');\n\nconst getInitialTourState = (tours: Tours) => {\n  return Object.keys(tours).reduce((acc, tourName) => {\n    acc[tourName as ValidTourName] = {\n      currentStep: 0,\n      isCompleted: false,\n    };\n\n    return acc;\n  }, {} as TourState);\n};\n\nconst getCompletedTours = (tours: TourState): ValidTourName[] => {\n  return Object.keys(tours).filter(\n    (tourName) => tours[tourName as ValidTourName].isCompleted\n  ) as ValidTourName[];\n};\n\nconst areAllToursCompleted = (tours: TourState) => Object.values(tours).every((t) => t.isCompleted);\n\nfunction reducer(state: State, action: Action): State {\n  return produce(state, (draft) => {\n    if (action.type === 'next_step') {\n      const currentStep = draft.tours[action.payload].currentStep;\n      const tourLength = guidedTours[action.payload]._meta.totalStepCount;\n\n      const nextStep = currentStep + 1;\n      draft.tours[action.payload].currentStep = nextStep;\n      draft.tours[action.payload].isCompleted = nextStep >= tourLength;\n    }\n\n    if (action.type === 'previous_step') {\n      const currentStep = draft.tours[action.payload].currentStep;\n\n      if (currentStep <= 0) return;\n\n      const previousStep = currentStep - 1;\n      draft.tours[action.payload].currentStep = previousStep;\n    }\n\n    if (action.type === 'skip_tour') {\n      draft.tours[action.payload].isCompleted = true;\n    }\n\n    if (action.type === 'set_completed_actions') {\n      draft.completedActions = [...new Set([...draft.completedActions, ...action.payload])];\n    }\n\n    if (action.type === 'remove_completed_action') {\n      draft.completedActions = draft.completedActions.filter(\n        (completedAction) => completedAction !== action.payload\n      );\n    }\n\n    if (action.type === 'skip_all_tours') {\n      draft.enabled = false;\n    }\n\n    if (action.type === 'reset_all_tours') {\n      draft.enabled = true;\n      draft.tours = getInitialTourState(guidedTours);\n      draft.completedActions = [];\n    }\n\n    if (action.type === 'go_to_step') {\n      draft.tours[action.payload.tourName].currentStep = action.payload.step;\n    }\n  });\n}\n\nconst STORAGE_KEY = 'STRAPI_GUIDED_TOUR';\nconst GuidedTourContext = ({\n  children,\n  enabled = true,\n}: {\n  children: React.ReactNode;\n  enabled?: boolean;\n}) => {\n  const { trackUsage } = useTracking();\n  const [storedTours, setStoredTours] = usePersistentState<State>(STORAGE_KEY, {\n    tours: getInitialTourState(guidedTours),\n    enabled,\n    completedActions: [],\n  });\n  const migratedTourState = migrateTours(storedTours);\n  const [state, dispatch] = React.useReducer(reducer, migratedTourState);\n\n  // Sync local storage\n  React.useEffect(() => {\n    setStoredTours(state);\n  }, [state, setStoredTours]);\n\n  // Derive all completed tours from state\n  const currentAllCompletedState = areAllToursCompleted(state.tours);\n  // Store completed state in ref to survive a re-render,\n  // when current state changes this will persist and be used for comparison\n  const previousAllCompletedStateRef = React.useRef(currentAllCompletedState);\n  React.useEffect(() => {\n    const previousAllCompletedState = previousAllCompletedStateRef.current;\n    // When the previous state was not complete but the current state is now complete, fire the event\n    if (!previousAllCompletedState && currentAllCompletedState) {\n      trackUsage('didCompleteGuidedTour', { name: 'all' });\n    }\n\n    // When the current state has all tours completed so will the previous state, the tracking event won't fire again\n    previousAllCompletedStateRef.current = currentAllCompletedState;\n  }, [currentAllCompletedState, trackUsage]);\n\n  return (\n    <GuidedTourProviderImpl state={state} dispatch={dispatch}>\n      {children}\n    </GuidedTourProviderImpl>\n  );\n};\n\nexport type { Action, State, ValidTourName };\nexport { GuidedTourContext, useGuidedTour, reducer, getCompletedTours };\n"],"names":["GuidedTourProviderImpl","useGuidedTour","createContext","getInitialTourState","tours","Object","keys","reduce","acc","tourName","currentStep","isCompleted","getCompletedTours","filter","areAllToursCompleted","values","every","t","reducer","state","action","produce","draft","type","payload","tourLength","guidedTours","_meta","totalStepCount","nextStep","previousStep","completedActions","Set","completedAction","enabled","step","STORAGE_KEY","GuidedTourContext","children","trackUsage","useTracking","storedTours","setStoredTours","usePersistentState","migratedTourState","migrateTours","dispatch","React","useReducer","useEffect","currentAllCompletedState","previousAllCompletedStateRef","useRef","previousAllCompletedState","current","name","_jsx"],"mappings":"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"}